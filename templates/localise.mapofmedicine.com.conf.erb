######################################################################
## Virtual host configration for <%= @name %>
######################################################################
# 
# Generated by Puppet for <%= @hostname %>
#
######################################################################

# Redirect requests for www.<%= @name %> to <%= @name %>
<VirtualHost "*:80">
    ServerName www.<%= @name %>

    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteRule ^(.*)$ http://<%= @name %>$1 [R]
    </IfModule>
</VirtualHost>

# Main configuration block for this virtual host
<VirtualHost "*:80">

#RewriteRule ^(.*)$ /var/www/vhosts/<%= @name %>/maintenance_index.html

#RewriteRule ^(.*)$ /var/www/vhosts/<%= @name %>/index_emergency.html


    # If the request uses the ServerName or ServerAlias as the server name, 
    # then this section will be used, otherwise they will be redirected to
    # the corporate site.

    ServerName <%= @name %>

    # The DocumentRoot isn't used for much, anything not inside a webapp.
    # Mainly this is used for the holding page.

    DocumentRoot /var/www/vhosts/<%= @name %>
    
    # This alias points to where the webapp is installed, so the static
    # files can be found.

    # Alias /mom /var/shared/deployment/prod/client-mms/webapps-running/mom
    
    # This alias points to where the attachments are installed.  These have been
    # moved outside of the webapp context base
    
    # Alias /mom/attachments /var/shared/deployment/prod/client-mms/attachments
    
    # This set of directives tells Apache NOT to use the ajp proxy to tomcat
    # to get files under these paths. So these are static files which will be
    # served directly by Apache, which improves performance.

    # ProxyPass /path/to/static/file/directory !

    # This is needed as a workaround for long transactions in the MMS.
    # See OPS-11139 for some details, IST-5075 for request to optimize specific
    # report in MMS that prompted this setting. Default is 300 seconds.
    
    ProxyTimeout 600

    # These are the main ajp proxy directives, they tell Apache to pass requests
    # to Tomcat.
    
    # In this iteration, one web server is hardlinked to a backend appserver. In
    # the future, we'll do somethis more clever with mod_proxy_balancer

    ProxyPass /mapmanager     ajp://<%= @app_hostname %>:9001/mapmanager
    ProxyPass /mom            ajp://<%= @app_hostname %>:9002/mom 
    ProxyPass /adminapp       ajp://<%= @app_hostname %>:9002/adminapp
    ProxyPass /previewloader  ajp://<%= @app_hostname %>:9002/previewloader
    ProxyPass /manager9001    ajp://<%= @app_hostname %>:9001/manager9001
    ProxyPass /manager9002    ajp://<%= @app_hostname %>:9002/manager9002

    # Main access block, this allows anonymous access to everything by default
    <Location "/">
        Options FollowSymLinks
        Order allow,deny
        Allow from all
    </Location>

    # Restricted access for the Tomcat manager webapp, locked by IP address.
    <Location "/tomcat-manager">
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
        Allow from 213.248.91.62
        Allow from 80.239.136.230
        Allow from 80.239.136.226
        Allow from 93.152.106.129
        Allow from 80.239.136.225
        Allow from 94.175.52.160
        Allow from 78.105.68.171
        Allow from 10.246.122.186
    </Location>
    
    # Batch control URL
    <Location "/mapmanager/quartzcontroller">
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
        Allow from 213.248.91.62
        Allow from 80.239.136.230
        Allow from 80.239.136.226
        Allow from 93.152.106.129
        Allow from 80.239.136.225
        Allow from 94.175.52.160
        Allow from 78.105.68.171
        Allow from 10.246.122.186
    </Location>
    
    # Use the specified error page (under DocumentRoot) for the specified error codes.
    # They are prettier than the standard Apache pages.

    ErrorDocument 403 /403/index.html 
    ErrorDocument 404 /404/index.html 

    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        # The holding page is DISABLED
        RewriteRule ^/holding.html / [R]
        
        # Redirect any access to the base URL to the mom index page, plus a few other
        # URL cleanups
        
        RewriteRule ^/$ /mapmanager [R,L]
        RewriteRule ^/admin$ /adminapp [R,L]
        
    </IfModule>

    # This statement figures out whether X-Forwarded-For is set.
    SetEnvIf X-FORWARDED-FOR "^.*\..*\..*\..*" behind-elb

    CustomLog "|/usr/bin/rotatelogs /var/log/apache2/access-<%= @name %>.log.%Y%m%d 86400" mtm env=!behind-elb
    CustomLog "|/usr/bin/rotatelogs /var/log/apache2/access-<%= @name %>.log.%Y%m%d 86400" mtm-elb env=behind-elb
    ErrorLog "|/usr/bin/rotatelogs /var/log/apache2/errors-<%= @name %>.log.%Y%m%d 86400"
    
    # Remote logging directives
    CustomLog "|/usr/bin/logger -p local6.info -t <%= @name %>" mtm env=!behind-elb
    CustomLog "|/usr/bin/logger -p local6.info -t <%= @name %>" mtm-elb env=behind-elb 
    ErrorLog "|/usr/bin/logger -p local7.err -t <%= @name %>"

</VirtualHost>


